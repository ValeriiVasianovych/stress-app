name: Deploy StressApp to EKS

on:
  workflow_dispatch:
    inputs:
      region:
        description: The region to deploy to
        required: true
        default: "us-east-1"
      aws_ecr_auth_role_arn:
        description: The ARN of the ECR authentication role
        required: true
      image_uri:
        description: The URI of the image to deploy
        required: true
      cluster_name:
        description: The name of the cluster to deploy to
        required: true
      namespace:
        description: The namespace to deploy to
        required: true

permissions:
  id-token: write
  contents: read

env:
  AWS_IAM_ROLE_ARN: ${{ secrets.AWS_IAM_ROLE_ARN }}
  EKS_CLUSTER_NAME: ${{ inputs.cluster_name }}
  AWS_REGION: ${{ inputs.region }}
  EKS_NAMESPACE: ${{ inputs.namespace }}

jobs:
  deploy:
    name: Deploy StressApp to EKS
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ env.AWS_IAM_ROLE_ARN }}

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Configure kubectl for EKS
        run: |
          aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name ${{ env.EKS_CLUSTER_NAME }}

      - name: Deploy StressApp with Helm
        run: |
          helm upgrade --install stress-app ./helm/stress-app \
            --create-namespace \
            --namespace ${{ env.EKS_NAMESPACE }} \
            --set serviceAccount.roleArn=${{ inputs.aws_ecr_auth_role_arn }} \
            --set image.uri=${{ inputs.image_uri }}

      - name: Verify Deployment
        run: |
          helm list --namespace ${{ env.EKS_NAMESPACE }}

  send-email:
    name: Send Deployment Notification Email
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Send Deployment Results
        uses: dawidd6/action-send-mail@v6
        with:
          server_address: ${{ secrets.MAIL_HOST }}
          server_port: ${{ secrets.MAIL_PORT }}
          username: ${{ secrets.MAIL }}
          password: ${{ secrets.MAIL_PASSWORD }}
          to: ${{ secrets.MAIL }}
          from: ${{ secrets.MAIL }}
          subject: GitHub Actions | StressApp EKS Deployment | ${{ needs.deploy.result }} | ${{ inputs.cluster_name }}
          html_body: |
            <!DOCTYPE html>
            <html>
            <head>
              <style>
                body { font-family: Arial, sans-serif; line-height: 1.6; color: #000; margin: 20px; }
                h1 { font-size: 18px; margin: 0 0 20px 0; }
                p { margin: 8px 0; }
                strong { font-weight: bold; }
                a { color: #0066cc; }
              </style>
            </head>
            <body>
              <h1>StressApp EKS Deployment Notification</h1>
              <p><strong>Status:</strong> <span style="color: ${{ needs.deploy.result == 'success' && 'green' || needs.deploy.result == 'failure' && 'red' || 'gray' }}; font-weight: bold;">${{ needs.deploy.result == 'success' && 'SUCCESS' || needs.deploy.result == 'failure' && 'FAILED' || 'CANCELLED' }}</span></p>
              <p><strong>EKS Cluster:</strong> ${{ inputs.cluster_name }}</p>
              <p><strong>Namespace:</strong> ${{ inputs.namespace }}</p>
              <p><strong>AWS Region:</strong> ${{ inputs.region }}</p>
              <p><strong>Image URI:</strong> ${{ inputs.image_uri }}</p>
              <p><strong>ECR Auth Role ARN:</strong> ${{ inputs.aws_ecr_auth_role_arn }}</p>
              <p><strong>Workflow Run:</strong> <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">View on GitHub</a></p>
              <p><strong>Triggered By:</strong> ${{ github.actor }}</p>
              <p><strong>Repository:</strong> <a href="${{ github.server_url }}/${{ github.repository }}">${{ github.repository }}</a></p>
              <p style="margin-top: 20px; font-size: 12px; color: #666;">This is an automated notification from GitHub Actions.</p>
            </body>
            </html>

