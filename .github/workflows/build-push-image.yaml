name: Build and Push StressApp Image to AWS ECR

on:
  push:
    branches: [ main ]

permissions:
  id-token: write
  contents: write

env:
  AWS_REGION: "us-east-1"
  AWS_IAM_ROLE_ARN: ${{ secrets.AWS_IAM_ROLE_ARN }}
  AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}

jobs:
  build-and-push:
    name: Build and Push to ECR
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ env.AWS_IAM_ROLE_ARN }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Automatic Tagging of Releases
        id: increment-git-tag
        run: |
          bash ./build/git_update.sh -v patch
      - name: Build Image and Push to ECR
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: "stressapp"
          IMAGE_TAG: ${{ steps.increment-git-tag.outputs.git-tag }}
        run: |
          echo "ECR_REGISTRY=$ECR_REGISTRY"
          echo "ECR_REPOSITORY=$ECR_REPOSITORY"
          echo "IMAGE_TAG=$IMAGE_TAG"
          aws ecr create-repository --repository-name $ECR_REPOSITORY --region ${{ env.AWS_REGION }} --image-scanning-configuration scanOnPush=true || echo "Repository already exists"
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          IMAGE_URI="$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
          echo "image_uri=$IMAGE_URI" >> $GITHUB_OUTPUT
          echo "ecr_registry=$ECR_REGISTRY" >> $GITHUB_OUTPUT
          echo "Built and pushed: $IMAGE_URI"
      
      - name: Ensure outputs are set
        id: ensure-outputs
        if: always()
        run: |
          if [ -z "${{ steps.build-image.outputs.image_uri }}" ]; then
            ECR_REG="${{ steps.login-ecr.outputs.registry }}"
            IMG_TAG="${{ steps.increment-git-tag.outputs.git-tag }}"
            if [ -n "$ECR_REG" ] && [ -n "$IMG_TAG" ]; then
              echo "image_uri=$ECR_REG/stressapp:$IMG_TAG" >> $GITHUB_OUTPUT
            fi
          else
            echo "image_uri=${{ steps.build-image.outputs.image_uri }}" >> $GITHUB_OUTPUT
          fi
          
          if [ -z "${{ steps.build-image.outputs.ecr_registry }}" ]; then
            echo "ecr_registry=${{ steps.login-ecr.outputs.registry }}" >> $GITHUB_OUTPUT
          else
            echo "ecr_registry=${{ steps.build-image.outputs.ecr_registry }}" >> $GITHUB_OUTPUT
          fi
    
    outputs:
      git-tag: ${{ steps.increment-git-tag.outputs.git-tag }}
      image-uri: ${{ steps.ensure-outputs.outputs.image_uri }}
      ecr-registry: ${{ steps.ensure-outputs.outputs.ecr_registry }}
  send-email:
    name: Send Deployment Notification Email
    runs-on: ubuntu-latest
    needs: [build-and-push]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Send Deployment Results
        uses: dawidd6/action-send-mail@v6
        with:
          server_address: ${{ secrets.MAIL_HOST }}
          server_port: ${{ secrets.MAIL_PORT }}
          username: ${{ secrets.MAIL }}
          password: ${{ secrets.MAIL_PASSWORD }}
          to: ${{ secrets.MAIL }}
          from: ${{ secrets.MAIL }}
          subject: GitHub Actions | StressApp ECR Deployment | ${{ needs.build-and-push.outputs.git-tag }} | ${{ needs.build-and-push.result }}
          html_body: |
            <!DOCTYPE html>
            <html>
            <head>
              <style>
                body { font-family: Arial, sans-serif; line-height: 1.6; color: #000; margin: 20px; }
                h1 { font-size: 18px; margin: 0 0 20px 0; }
                p { margin: 8px 0; }
                strong { font-weight: bold; }
                a { color: #0066cc; }
              </style>
            </head>
            <body>
              <h1>Main Workflow Deployment Results</h1>
              <p><strong>Status:</strong> ${{ needs.build-and-push.result == 'success' && 'SUCCESS' || needs.build-and-push.result == 'failure' && 'FAILED' || 'CANCELLED' }}</p>
              <p><strong>Image Tag:</strong> ${{ needs.build-and-push.outputs.git-tag || 'N/A' }}</p>
              <p><strong>ECR Image URI:</strong> ${{ needs.build-and-push.outputs.image-uri || 'N/A' }}</p>
              <p><strong>AWS Region:</strong> ${{ env.AWS_REGION }}</p>
              <p><strong>ECR Registry:</strong> ${{ needs.build-and-push.outputs.ecr-registry || 'N/A' }}</p>
              <p><strong>Workflow Run:</strong> <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">View on GitHub</a></p>
              <p><strong>Commit:</strong> <a href="${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}">${{ github.sha }}</a></p>
              <p><strong>Commit Message:</strong> ${{ github.event.head_commit.message || 'N/A' }}</p>
              <p><strong>Triggered By:</strong> ${{ github.actor }}</p>
              <p><strong>Branch:</strong> ${{ github.ref_name }}</p>
              <p><strong>Repository:</strong> <a href="${{ github.server_url }}/${{ github.repository }}">${{ github.repository }}</a></p>
              <p style="margin-top: 20px; font-size: 12px; color: #666;">This is an automated notification from GitHub Actions.</p>
            </body>
            </html>